# Orchestrate OS — Semantic Control Board

## Overview
Orchestrate OS is a governance-only semantic control plane for defining, validating, and previewing semantic rules offline. It serves as a single source of semantic truth to streamline patch requests, enhance operator ergonomics, and provide an analyst-first reference for explicit, deterministic, and auditable decisions. The system aims to improve semantic rule management, reduce errors, and enhance decision-making efficiency by capturing semantic decisions as reviewable configuration artifacts and operating offline-first with deterministic outputs. Its business vision is to provide a robust platform for managing complex semantic rules, ensuring data integrity, and facilitating efficient decision-making in various operational contexts.

## User Preferences
Preferred communication style: Simple, everyday language.

## System Architecture
The system employs a Config Pack Model with strict version matching and a 12-status lifecycle for patch requests, including comment systems and role-based access control. The UI/UX features a dashboard with a queue-centric sidebar, right-side drawers, role-based navigation, and a Patch Studio for drafting and preflight checks with live previews and revision tracking. Data handling supports CSV/XLSX import, inline editing, a lock-on-commit mechanism with a change map engine, and workbook session caching.

The Admin Panel is organized into five tabs: Pipeline, Schema & Standards, Quality & Gates, Patch Ops, and People & Access. Semantic rules follow a WHEN/THEN pattern, generating deterministic cell-level signals for validation and grid coloring. Access control is email-based via Google sign-in. Key features include a "Contract Line Item Wizard," XLSX export, Audit Timeline, Schema Tree Editor, and Batch Merge. The architecture includes `SystemPass` for deterministic changes, `UndoManager` for session-scoped draft edits, `RollbackEngine` for governed rollback artifacts, and a Triage Analytics module.

The system supports Postgres-backed multi-user persistence with resource-based routes, ULID primaries, optimistic concurrency, and server-enforced no-self-approval. Authentication uses Google OAuth for human users and scoped API keys for service ingestion, with strict workspace isolation. A sandbox/demo mode is available.

An Evidence Viewer provides document-level text anchoring, a corrections workflow, and RFI custody tracking, with an interactive panel and unified click behavior for validation. It supports a two-column layout with a document viewer (Reader/PDF toggle) and an Evidence Details panel. Reader mode includes text extraction, formatting, Mojibake inline detection, and OCR escalation. A selection action menu allows creating Evidence Marks, RFIs, and Corrections. Grid Record Labels are standardized. Sandbox Session Management ensures artifact persistence.

A heuristic suggestion engine analyzes source document column headers, proposing mappings to canonical glossary terms using exact, fuzzy, and keyword matching. It includes a local-fallback mode and persists diagnostics metadata. The UI Suggestions Panel features keyword overlay highlighting, linked fields, and a compact diagnostics status line. Users can accept/decline suggestions, which auto-creates glossary aliases. Section Metadata Integration groups and orders fields in the record inspector, providing "what to look for" guidance. A Module Registry manages system modules like `Engines.SuggestionsState` and `Components.SuggestionsPanel`.

UX Fine-Tuning includes locked clarity decisions, slim section group headers, canonical field labels, sticky guidance cards, live contract chip refresh, bulk verification by section, inline mojibake character highlighting, and enhanced context menus. The "Create Alias" feature in the Evidence Viewer Reader allows creating glossary aliases directly from selected text. Enhanced Contract Line Items support batch add workflows.

Document Mode Preflight provides deterministic page/document classification and quality gating for PDF documents, classifying pages as SEARCHABLE, SCANNED, or MIXED, and assigning gate colors based on quality checks. An Admin Sandbox Preflight Test Lab allows testing single PDFs and generating detailed reports. An OGC Preparation Simulator (v0), an admin-only sandbox feature, enables operators to run preflight, review results in a gate-driven modal, toggle OGC Preview, and export deterministic `prep_export_v0` JSON.

Glossary Fuzzy Confidence Scoring uses a 6-component weighted formula for candidate scoring, categorizing confidence into HIGH, MEDIUM, LOW, and HIDDEN buckets, with deterministic tie-breaking. Normalization includes NFKC, lowercase, punctuation stripping, and noise token removal. Candidate suppression filters out irrelevant strings. Entity-specific handling preserves numeric-leading names. The UI shows top candidates with confidence percentages and reason chips. The glossary index merges `field_meta.json` with database glossary terms.

Body Text Candidate Extraction identifies domain-relevant phrases from PDF body text using sliding word windows and filters. These candidates are merged with header candidates and scored together, with "BODY" badges in the UI. Single-Token Domain Boost applies a specific boost for single-token candidates matching multi-token glossary entries. Category Starvation Prevention (`_apply_category_balance()`) ensures balanced representation across glossary categories by capping results per category. Scoring Config Freeze centralizes all scoring weights, thresholds, and boost multipliers in a `SCORING_CONFIG` dictionary. Export Contract Hardening validates cached state completeness before building export payloads, returning a 422 if required fields are missing.

A Salesforce Resolver Stub (`server/resolvers/salesforce.py`) provides an interface contract for entity resolution, currently a mock provider.

OGC Preparation Simulator v2.54 Operations View provides a multi-batch, DB-first governance queue for verifiers/admins. It unifies patches, RFIs, and corrections into a single feed via `GET /workspaces/{ws}/operations/queue`. Feature flags `OPS_VIEW_DB_READ` and `OPS_VIEW_DB_WRITE` enable gradual migration from localStorage to PostgreSQL-backed Annotation Layer with rollback safety.

v2.55 Verifier Organizational View (`#/verifier-org`) provides a workspace-level governance dashboard for verifiers and admins. Features include: KPI summary strip, batch queue table with per-batch rollups, batch drill-down table showing individual queue items with action buttons, and a filter bar with status/type dropdowns and URL state sync. It is RBAC-guarded for verifier and admin roles.

V2.56 Verifier Triage Unification migrates the standalone `#/verifier-org` page into the canonical `#page-triage` frame, creating a role-adaptive interface where analysts see contract-centric sections and verifiers/admins see governance sections.

Dark Mode v2 ("Subtle Futuristic Neon Control Panel") uses `ui/viewer/theme.css` as the single source of truth for all color tokens, supporting both light and dark modes with a distinct blue-gray base and bright text. The toggle persists to localStorage. The Sidebar Icon System uses inline SVG icons with `currentColor` inheritance and custom CSS properties for theme integration. A Collapsible Sidebar feature allows users to collapse the navigation, with state persisted to localStorage.

Google Drive Save (XLSX Export) supports hierarchical folder routing with per-member priority and automatic folder bootstrapping. The export filename format is `{batch_id}-{actor}-{status}-{timestamp}.xlsx`. The workbook structure includes DATA sheets (with cell styling), GOV_META, ACTIONS, STATE_JSON, plus legacy sheets. Workspace drive folder settings are configurable via the People & Access > Drive admin sub-tab.

Field Suggestions UI upgrade (v2.56) adds collapsible section headers with per-section status pills, localStorage-based collapse persistence, right-click context menu for field cards, and dark mode CSS variable fixes. The CSV-backed Account Resolver (`server/resolvers/salesforce.py`) provides 3-tier deterministic matching (exact → token overlap → edit distance) against `CMG_Account.csv` via `AccountIndex`, with configurable thresholds, max 5 candidates, and stable sort.

Preflight Test Lab — Salesforce Match Integration (v2.56) wires the Salesforce account resolver into the preflight pipeline. The preflight engine uses `extract_account_candidates(full_text, extracted_headers)` with strict extraction: (1) CSV-first exact phrase scan via `_csv_phrase_scan` finding known account names in body text with word-boundary matching, (2) strict label:value extraction via `_STRICT_LABEL_VALUE_RE` anchored to line start for accepted labels only (Account Name, Company Name, Artist Name, Legal Name and their Salesforce field variants), with prose rejection via `_is_prose()` filtering out legal clauses and `_is_valid_value()` rejecting generic single tokens, (3) header fallback as last resort. Stop-label filtering (`_SF_STOP_LABELS`) excludes pure labels. `_run_salesforce_match(extracted_headers, full_text)` resolves extracted candidate values. A JS helper `_pftlExtractAccountCandidates` mirrors the server logic client-side. The UI renders a matrix-style table with Source Text, Mapped Account, Match Status, Confidence, and Evidence columns, positioned after encoding findings. Deterministic sorting: review first, no-match, match; confidence desc; alpha tie-breaker.

Multi-Account Aware Composite Scoring (v2.57) adds context-aware scoring via `server/resolvers/context_scorer.py`. Each candidate gets a composite score: `name_evidence (up to 0.55) + address_evidence (up to 0.30) + account_context (up to 0.20) - service_penalty (up to 0.35)`. Multiple valid accounts are retained when each has sufficient evidence (score >= 0.25 display threshold). Account-context boost uses two-tier cues: strong cues (account name, company name, legal name, licensee, licensor, billing address, registered office, party, counterparty, payee, vendor) and weak cues (limited, llc, inc, ltd, corp, corporation). Full boost requires at least one strong cue; weak-only gives reduced boost (max 25% ratio). Proximity uses strict (60-char) and soft (120-char) windows. Service-context penalty is source-aware: strict_label_value caps penalty at 0.08, csv_phrase_hit caps at 0.15 (unless known DSP). Address evidence is candidate-local (150-char proximity window, not global page presence), using regex-based extraction with no cross-line matching. Scoring tiers: full address verified (0.30), partial with ZIP (0.18), partial with city (0.15), partial street only (0.09). Evidence chips per row: name_exact/name_fuzzy, address_partial/address_verified, account_context, service_context_penalty, city_match/zip_match. Match status mapping: match (composite >= 0.65 with safe name), review (>= 0.40), no-match (below threshold or penalty-dominant). Generic/common-token candidates max status = review unless strict_label_value source. Hidden bucket collects low-signal candidates below display threshold. UI renders visible rows in main table and hidden rows in a collapsible details section with chip color coding (positive=green, negative=red, neutral=amber), dark mode support, and a Debug toggle showing source_type and scoring_breakdown per row.

Candidate extraction uses a hard denylist (distribution, trademark, delay, image, mean, prosecute, secrets, master, territory, term, schedule, exhibit, section, etc.) to suppress legal/common noise tokens unless extracted via strict label:value. Single-token uppercase words (≤6 chars) are also denied. `extract_account_candidates()` returns dicts with `{"value": str, "source_type": str}` where source_type is strict_label_value, csv_phrase_hit, or header_fallback. Ranking sorts by source_type priority (strict > csv > header), then status (review > no-match > match), then confidence desc, then source alpha.

Resolution Story P0 (v2.57+) adds `build_resolution_story()` to `server/preflight_engine.py`, producing a structured narrative from SF match results. CMG-side gating is a locked rule: `legal_entity_account` must be a CMG entity (checked via `_CMG_KNOWN_ALIASES` set including Ostereo/Asterio variants, or `_CMG_ACCOUNT_TYPES` = "division" from CSV). If no CMG candidate passes threshold, `legal_entity_account = null` and `requires_manual_confirmation = true`. `counterparties[]` contains non-CMG candidates above `REVIEW_THRESHOLD (0.40)`. Role selection is confidence-first within role constraints, independent of table sort order. `_guess_agreement_type()` uses keyword-weighted heuristic (title zone 3x, body 1x) returning one of: distribution, license, recording, publishing, management, service, amendment, unknown. `recital_parties` is stubbed as `[]` for V1. Per-candidate fields `label_value_hit` and `recital_party_hit` added to `salesforce_match[]` rows. The `resolution_story` key is added to `run_preflight()` output alongside (not replacing) `salesforce_match`. Note: "Asterio" is an alternate spelling of "Ostereo" — both refer to the same entity.

A Salesforce Resolver Stub (`server/resolvers/salesforce.py`) provides an interface contract for entity resolution, currently a mock provider.

## External Dependencies
- **FastAPI server**: Used as a local PDF proxy for CORS-safe PDF fetching and text extraction using PyMuPDF.
- **SheetJS (XLSX)**: Integrated for Excel import/export functionality.
- **Google Drive**: Integrated as a data source for contract workbook import/export, with role-based folder routing for XLSX exports.