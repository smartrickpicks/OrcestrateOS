# Orchestrate OS — Semantic Control Board

## Overview
Orchestrate OS is a governance-only semantic control plane designed for defining, validating, and previewing semantic rules offline. It acts as a single source of semantic truth to streamline patch requests, enhance operator ergonomics, and provide an analyst-first reference for explicit, deterministic, and auditable decisions. The system aims to improve semantic rule management, reduce errors, and enhance decision-making efficiency by capturing semantic decisions as reviewable configuration artifacts and operating offline-first with deterministic outputs.

## User Preferences
Preferred communication style: Simple, everyday language.

## System Architecture
The system utilizes a Config Pack Model with strict version matching and supports a 12-status lifecycle for patch requests, including comment systems and role-based access control. The UI/UX features a dashboard with a queue-centric sidebar, right-side drawers, role-based navigation, and a Patch Studio for drafting and preflight checks with live previews and revision tracking. Data handling supports CSV/XLSX import, inline editing, a lock-on-commit mechanism with a change map engine, and workbook session caching.

Admin Panel has 5 tabs: **Pipeline** (artifact registry, workflow map, demo dataset, contract line item wizard, merge batches), **Schema & Standards** (schema tree editor, unknown columns, canonical glossary), **Quality & Gates** (version & baseline, evidence gates, preflight test lab, QA runner, JSON inspector), **Patch Ops** (patch queue, patch requests console), **People & Access** (environment mode, members/roles/invites). The Architect Controls bar at the bottom is collapsible and remembers its state. Old tab names (qa-runner, runtime-config, config, inspector) are aliased to their new locations via `switchAdminTab()`.

Semantic rules follow a WHEN/THEN pattern, generating deterministic cell-level signals using metadata for validation, populating Analyst Triage queues, and driving grid coloring. Access control is email-based with Google sign-in. Key features include a "Contract Line Item Wizard," XLSX export capabilities, an Audit Timeline, a Schema Tree Editor for canonical rules bundles, and a Batch Merge feature. The architecture includes `SystemPass` for deterministic changes, `UndoManager` for session-scoped draft edits, `RollbackEngine` for governed rollback artifacts, and a Triage Analytics module.

The system supports Postgres-backed multi-user persistence with resource-based routes, ULID primaries, optimistic concurrency, and server-enforced no-self-approval. Authentication uses Google OAuth for human users and scoped API keys for service ingestion, with strict workspace isolation. Sandbox/demo mode uses a dev-only auth bypass (`_SANDBOX_AUTH_ALLOWED` in `server/auth.py`) that creates a synthetic admin auth when `X-Sandbox-Mode: true` header is present and no real auth resolves; this bypass is disabled in production deployments.

An Evidence Viewer provides document-level text anchoring, corrections workflow, and RFI custody tracking. It features an interactive panel with Anchors, Corrections, and RFI Custody sections. It supports unified click behavior for opening the panel and subsequent cell validation, and a context menu for "Review Mode." The Evidence Viewer mode uses a two-column layout with a document viewer (Reader/PDF toggle) and Evidence Details panel on the left, and the grid table on the right. Reader mode includes text extraction, formatting, Mojibake inline detection with visual classifications, and an OCR escalation CTA. A selection action menu allows creating Evidence Marks, RFIs, and Corrections, with policy-driven status assignments and RFI lifecycle propagation.

Grid Record Labels are standardized as `Contract: Account` or `Contract: Account: Opportunity` in the first, sticky data column.

Sandbox Session Management ensures sandbox-created artifacts persist indefinitely until explicitly reset by an admin, with options to "Reset Sandbox" or "Reset All Data."

A heuristic suggestion engine (v2) analyzes source document column headers and proposes mappings to canonical glossary terms using exact, fuzzy, and keyword matching strategies. Keyword scoring uses `field_meta.json` tokens (labels, definitions, picklist options) instead of hardcoded category buckets. A local-fallback mode (`/api/v2.5/suggestion-runs/local`) accepts source_fields directly from workbook headers without requiring a materialized document row. Diagnostics metadata (run_mode, field_meta availability, match distribution) is persisted in suggestion_runs.metadata and suggestions.metadata JSONB columns. The UI Suggestions Panel includes keyword overlay highlighting in the Evidence Viewer reader (Show/Clear per suggestion row), suggestion-derived Linked Fields with orange border when no real anchors exist, and a compact diagnostics status line showing run mode and match counts. Users can accept or decline suggestions, which auto-creates glossary aliases. This feature integrates with database tables for glossary terms, aliases, suggestion runs, and suggestions, and requires explicit workspace selection for glossary endpoints.

Section Metadata Integration groups and orders fields in the record inspector based on `enrichments.section_metadata`, falling back to legacy grouping if absent. Section Focus Guidance provides "what to look for" guidance based on `section_focus` from `enrichments.section_metadata` or `config/section_guidance.json`.

Module Registry manages system modules, including `Engines.SuggestionsState` and `Components.SuggestionsPanel`.

UX Fine-Tuning includes locked clarity decisions, slim section group headers, canonical field labels, sticky guidance cards, live contract chip refresh, bulk verification by section, inline mojibake character highlighting, and enhanced context menus. The "Create Alias" feature in the Evidence Viewer Reader allows creating glossary aliases directly from selected text, auto-populating grid cells, and creating evidence marks.

Enhanced Contract Line Items allow the batch add modal to capture source row context, enabling "duplicate row, change one field" workflows for adding missing records.

Document Mode Preflight provides a deterministic page/document classification and quality gate system for PDF documents, classifying pages as SEARCHABLE, SCANNED, or MIXED, and assigning gate colors (GREEN, YELLOW, RED) based on quality checks. It includes an Admin Sandbox Preflight Test Lab for running preflight on single PDFs, providing detailed reports.

OGC Preparation Simulator (v0) is an admin-only sandbox feature enabling operators to run preflight, review results in a gate-driven modal (CONTINUE/ACCEPT_RISK/ESCALATE_OCR/CANCEL), toggle OGC Preview (show/hide only, no recompute), and export deterministic `prep_export_v0` JSON from cached state. The simulator uses `preflightSyncState` as the canonical client state object, `renderSyncPreflightPanel()` renders the review modal, and `runSyncPreflight()` triggers analysis. Server-side export endpoint at `GET /api/preflight/export?doc_id=X` reads from `_preflight_cache` without recomputing. All gated behind existing `PREFLIGHT_GATE_SYNC` flag. No DB schema changes, no autonomous triggers, no extraction/matching changes. Export contract documented in `docs/preflight/OGC_PREP_EXPORT_CONTRACT.md`. Optional evaluation block supports TTT-2 timing with `valid_for_rollup = targets_labeled >= 5`.

Glossary Fuzzy Confidence Scoring uses a 6-component weighted formula: `S = 0.45*EXACT_ALIAS + 0.20*TOK_OVERLAP + 0.12*ORDERED_OVERLAP + 0.18*EDIT_SIM + 0.03*FIRST_TOKEN_BONUS + 0.02*CONTEXT_BONUS`. Entity-eligible candidates (numeric-leading + entity token) get +5% boost with entity context. Confidence buckets: HIGH (>=80%, auto-suggest), MEDIUM (60-79%, suggest for review), LOW (40-59%, collapsed by default), HIDDEN (<40%, suppressed). Exact alias hits force HIGH bucket. Deterministic tie-breaking: confidence_pct DESC, exact_alias DESC, tok_overlap DESC, edit_sim DESC, glossary_field_key ASC. Normalization uses NFKC + lowercase + punctuation strip + NOISE_TOKENS removal (preserving KEEP_TOKENS for domain/entity terms). Candidate suppression removes section markers, URL-heavy, numeric-heavy, mojibake, and too-short strings from primary list (debug-only visibility). Entity-specific handling preserves numeric-leading names like "1888 Records". Scoring uses rapidfuzz==3.14.3 for edit-distance similarity (token_sort_ratio + per-token Levenshtein). UI shows top 1-3 candidates per source field with confidence %, reason chips (Exact alias, Token overlap, Ordered match, Edit-sim, Context boost, Entity rule, First-token anchor), and admin-only "Suppressed Candidates" debug section. The glossary index merges field_meta.json (442 canonical fields) with DB glossary_terms, deduplicating by field_key. Return signature: `(suggestions, diagnostics, suppressed_list)`. No schema changes.

Body Text Candidate Extraction: `_extract_body_text_candidates()` extracts domain-relevant phrases from PDF body text (not just headers). Uses sliding word windows (1-4 words) for long phrases, filters for DOMAIN_SIGNAL_TOKENS and KEEP_TOKENS. Body candidates are merged with header candidates (deduped) and scored together. The local suggestion route and preflight test lab UI pass `body_text` from extracted PDF text. Body-text suggestions display a "BODY" badge in the UI.

Single-Token Domain Boost: When a single-token candidate (e.g., "Synch") matches a multi-token glossary entry (e.g., "Sync License Type"), a domain boost applies: `best_single_sim * 0.78` if the best per-token Levenshtein similarity >= 0.75 and the token is in DOMAIN_SIGNAL_TOKENS or KEEP_TOKENS. This ensures terms like "Synch" reliably match at MEDIUM confidence.

Category Starvation Prevention: `_apply_category_balance()` prevents any single glossary category from dominating results. Uses `max_per_category = max(2, total // (n_cats * 2) + 1)` cap, collecting top items per category first, then appending overflow by score. Ensures balanced representation across identity, contract, catalog, and financial categories.

Scoring Config Freeze: All scoring weights, thresholds, boost multipliers, and chip thresholds are centralized in `SCORING_CONFIG` dict at the top of `server/suggestion_engine.py`. Weights sum to 1.0. All scoring functions reference this config instead of inline constants. Tie-break order is documented in config.

Export Contract Hardening: Export endpoints (`GET /api/preflight/export`, `POST /api/preflight/export`) validate cached state completeness before building export payload. Missing required fields (doc_mode, gate_color, metrics, page_classifications) return 422 INVALID_CACHE_STATE. Export remains cache-backed only with no recompute.

Salesforce Resolver Stub: `server/resolvers/salesforce.py` provides the `resolve_entity(workspace_id, name, address=None)` interface contract returning classification, score, candidates, explanation, provider, and resolved status. Default off via `SALESFORCE_RESOLVER_ENABLED` flag. Mock provider only — no network calls, no live API. Integration-ready as an additive confidence signal input.

Tests: `tests/test_suggestion_engine.py` contains 49 deterministic tests covering sync/synch matching, alias-present/removed cases, genericity (non-sync typo families), no-hardcoding verification, determinism across reruns, scoring config freeze validation, export contract validation, Salesforce resolver stub, alias fuzzy paths, suppression rules, entity eligibility, deterministic ordering/tie-breaking, body text extraction, category balance, normalization, and reason chip generation.

Dark Mode v2 ("Blue Steel + Ember Edge") uses a CSS token-based theming system via `html[data-theme="dark"]`. All colors are defined as CSS custom properties (--bg-0 through --bg-4, --text-primary/secondary/muted/disabled, --accent-bright, --ember-border, --focus-ring, --ok/warn/bad/info with derived -bg/-border tokens, --shadow-1/2, --glow-blue/ember-soft/med). The toggle switch in the sidebar persists preference to localStorage key `orchestrate-dark-mode`. A pre-paint script applies the attribute before CSS renders. Glow effects are applied to section headers (glow-blue-soft), KPI numbers (glow-blue-med), and active/selected nav items (ember glow). Focus-visible ring is globally applied. Inline style overrides use `!important` to beat hardcoded backgrounds.

## External Dependencies
- **FastAPI server**: Used as a local PDF proxy for CORS-safe PDF fetching and text extraction using PyMuPDF.
- **SheetJS (XLSX)**: Integrated for Excel import/export functionality.
- **Google Drive**: Integrated as a data source for contract workbook import/export.