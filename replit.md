# Orchestrate OS — Semantic Control Board

## Overview
Orchestrate OS is a governance-only semantic control plane designed for defining, validating, and previewing semantic rules offline. It acts as a single source of semantic truth to streamline patch requests, enhance operator ergonomics, and provide an analyst-first reference for explicit, deterministic, and auditable decisions. The system aims to improve semantic rule management, reduce errors, and enhance decision-making efficiency by capturing semantic decisions as reviewable configuration artifacts and operating offline-first with deterministic outputs. Its business vision is to provide a robust platform for managing complex semantic rules, ensuring data integrity, and facilitating efficient decision-making in various operational contexts.

## User Preferences
Preferred communication style: Simple, everyday language.

## System Architecture
The system utilizes a Config Pack Model with strict version matching and supports a 12-status lifecycle for patch requests, including comment systems and role-based access control. The UI/UX features a dashboard with a queue-centric sidebar, right-side drawers, role-based navigation, and a Patch Studio for drafting and preflight checks with live previews and revision tracking. Data handling supports CSV/XLSX import, inline editing, a lock-on-commit mechanism with a change map engine, and workbook session caching.

The Admin Panel is structured into five key tabs: Pipeline, Schema & Standards, Quality & Gates, Patch Ops, and People & Access, providing comprehensive control over system artifacts, schema definitions, quality assurance, patch management, and user access. Semantic rules follow a WHEN/THEN pattern, generating deterministic cell-level signals for validation and grid coloring. Access control is email-based via Google sign-in. Key features include a "Contract Line Item Wizard," XLSX export, an Audit Timeline, a Schema Tree Editor, and a Batch Merge feature. The architecture includes `SystemPass` for deterministic changes, `UndoManager` for session-scoped draft edits, `RollbackEngine` for governed rollback artifacts, and a Triage Analytics module.

The system supports Postgres-backed multi-user persistence with resource-based routes, ULID primaries, optimistic concurrency, and server-enforced no-self-approval. Authentication uses Google OAuth for human users and scoped API keys for service ingestion, with strict workspace isolation. A sandbox/demo mode is available for development.

An Evidence Viewer provides document-level text anchoring, a corrections workflow, and RFI custody tracking, featuring an interactive panel and unified click behavior for validation. It supports a two-column layout with a document viewer (Reader/PDF toggle) and an Evidence Details panel. Reader mode includes text extraction, formatting, Mojibake inline detection, and OCR escalation. A selection action menu allows creating Evidence Marks, RFIs, and Corrections. Grid Record Labels are standardized for clarity. Sandbox Session Management ensures artifact persistence until reset.

A heuristic suggestion engine (v2) analyzes source document column headers, proposing mappings to canonical glossary terms using exact, fuzzy, and keyword matching. It includes a local-fallback mode and persists diagnostics metadata. The UI Suggestions Panel features keyword overlay highlighting, linked fields, and a compact diagnostics status line. Users can accept/decline suggestions, which auto-creates glossary aliases. Section Metadata Integration groups and orders fields in the record inspector, providing "what to look for" guidance. A Module Registry manages system modules like `Engines.SuggestionsState` and `Components.SuggestionsPanel`.

UX Fine-Tuning includes locked clarity decisions, slim section group headers, canonical field labels, sticky guidance cards, live contract chip refresh, bulk verification by section, inline mojibake character highlighting, and enhanced context menus. The "Create Alias" feature in the Evidence Viewer Reader allows creating glossary aliases directly from selected text. Enhanced Contract Line Items support batch add workflows.

Document Mode Preflight provides deterministic page/document classification and quality gating for PDF documents, classifying pages as SEARCHABLE, SCANNED, or MIXED, and assigning gate colors based on quality checks. An Admin Sandbox Preflight Test Lab allows testing single PDFs and generating detailed reports. An OGC Preparation Simulator (v0), an admin-only sandbox feature, enables operators to run preflight, review results in a gate-driven modal, toggle OGC Preview, and export deterministic `prep_export_v0` JSON.

Glossary Fuzzy Confidence Scoring uses a 6-component weighted formula for candidate scoring, categorizing confidence into HIGH, MEDIUM, LOW, and HIDDEN buckets. Deterministic tie-breaking rules are applied. Normalization includes NFKC, lowercase, punctuation stripping, and noise token removal. Candidate suppression filters out irrelevant strings. Entity-specific handling preserves numeric-leading names. The UI shows top candidates with confidence percentages and reason chips. The glossary index merges `field_meta.json` with database glossary terms.

Body Text Candidate Extraction identifies domain-relevant phrases from PDF body text using sliding word windows and filters. These candidates are merged with header candidates and scored together, with "BODY" badges in the UI. Single-Token Domain Boost applies a specific boost for single-token candidates matching multi-token glossary entries. Category Starvation Prevention (`_apply_category_balance()`) ensures balanced representation across glossary categories by capping results per category. Scoring Config Freeze centralizes all scoring weights, thresholds, and boost multipliers in a `SCORING_CONFIG` dictionary. Export Contract Hardening validates cached state completeness before building export payloads, returning a 422 if required fields are missing.

A Salesforce Resolver Stub (`server/resolvers/salesforce.py`) provides an interface contract for entity resolution, currently a mock provider.

Dark Mode v2 — Palette B ("Subtle Futuristic Neon Control Panel") uses `ui/viewer/theme.css` as the single source of truth for all color tokens. Light mode uses `:root` tokens; dark mode uses `html[data-theme="dark"]` with blue-gray bases (#0B1220 → #0F1A2E → #13233B → #1A2E4B → #102642), bright text (#EAF2FF / #B8C7E6 / #8EA2C8), violet accent (#8B5CF6), cyan secondary (#22D3EE), blue links (#60A5FA), amber warnings (#F59E0B), orange OCR (#FB923C), and neon status colors (ok #34D399, warn #FBBF24, bad #FB7185, info #60A5FA, blocked #F87171). Domain-specific tokens: lifecycle cards (--life-bg/border/active-bg/active-border/done/blocked), schema snapshot tiles (--tile-bg/border, --tile-mapped/unknown/missing/quality with -accent and -bg variants), banners (--banner-bg/border/text and --banner-warn-bg/border/text), encoding highlights (--encoding-ink/bg/underline and --encoding-mark-bg/border/text for target-only underline+chip), tables (--table-bg/head-bg/head-text/row-bg/row-alt/row-hover/text/text-muted), chips (--chip-bg/border/hover), sections (--section-title/subtitle, --pill-bg/border). Lifecycle cards use CSS classes (ta-lifecycle-stage, ta-lifecycle-active) instead of inline JS colors. Mojibake encoding highlights use token-driven underline+background per-span (not full container wash) — section containers keep normal --bg-2, only mojibake spans get the mark bg/border. Toggle persists to localStorage key `orchestrate-dark-mode`. Pre-paint script in `<body>` prevents flash.

The Sidebar Icon System uses inline SVG icons (`.sidebar-icon`) with `currentColor` inheritance and custom CSS properties for theme integration. A Collapsible Sidebar feature allows users to collapse the navigation for more screen real estate, with state persisted to localStorage.

Google Drive Save (XLSX Export) supports role-based folder routing: analysts export to a verifier folder, verifiers/admins export to an admin folder, with automatic folder bootstrap if subfolders don't exist. The export filename format is `{batch_id}-{actor}-{status}-{timestamp}.xlsx`. The workbook structure includes DATA sheets (with cell styling), GOV_META (governance metadata key-value pairs), ACTIONS (merged patch requests, change map edits, and RFIs), STATE_JSON (serialized session state), plus legacy sheets (_change_log, RFIs, _signals_summary, _orchestrate_meta, Audit_Log). Workspace drive folder settings (root/verifier/admin folder IDs) are configurable via the People & Access > Drive admin sub-tab. Drive status diagnostics include has_token, expires_at, scopes, redirect_uri_expected, and failure_reason for troubleshooting OAuth issues.

## External Dependencies
- **FastAPI server**: Used as a local PDF proxy for CORS-safe PDF fetching and text extraction using PyMuPDF.
- **SheetJS (XLSX)**: Integrated for Excel import/export functionality.
- **Google Drive**: Integrated as a data source for contract workbook import/export, with role-based folder routing for XLSX exports.