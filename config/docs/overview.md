# Orchestrate OS v2.5 — Quick Reference

Orchestrate OS is a Postgres-backed, API-driven governance system for music industry contract data. It provides role-gated collaboration, evidence-based corrections, and deterministic audit trails. Google OAuth authenticates users; Google Drive serves as a first-class data source and export target.

## Canonical Language Rule

All documentation, UI labels, and schemas must use canonical terms only. No synonyms or aliases. This ensures consistency across docs, UI, and data schemas.

## Roles

| Role | Can Do | Cannot Do |
|------|--------|-----------|
| **Analyst** | Load data, triage signals, draft patches, attach evidence, submit patches, submit RFIs | Approve own patches, promote to truth, manage members |
| **Verifier** | Review patches, test corrections, approve/reject patches, raise RFIs | Submit patches, promote to truth, manage members |
| **Admin** | Promote approved patches, manage members, configure workspace, archive contracts | Skip verifier approval (no self-approval) |
| **Architect** | Calibrate truth config, set baselines, full system access | N/A (highest privilege) |

Sandbox mode allows Admin/Architect to simulate Analyst or Verifier roles. All simulated actions are tagged in audit events.

## Surfaces (UI Views)

| Surface | Purpose |
|---------|---------|
| **Landing** | Google Sign-In, workspace selection |
| **Triage** | Role-specific queue of items needing attention — the default view for all roles |
| **All Data Grid** | Contract-first navigation across all loaded records with inline editing |
| **Record Inspection** | Deep-dive into a single record: field values, signals, patch history, PDF evidence |
| **Patch Studio** | Draft, preflight, and submit patches with evidence packing and live preview |
| **Data Source Panel** | Connect Google Drive, browse folders, import/export workbooks, manage sessions |
| **Admin Configuration** | Six tabs: Governance, Schema Standards, Patch Ops, People & Access, QA Runner, Runtime Config |
| **Schema Tree Editor** | Manage the canonical rules bundle: field_meta, hinge_groups, sheet_order, qa_flags, document_types, column_aliases |
| **Audit Timeline** | Chronological log of all governance actions with filtering |
| **PDF Viewer** | Side-by-side PDF evidence inspection with anchor search and highlighting |
| **Contract Health Dashboard** | 0-100 health score per contract with critical/at-risk/watch/healthy bands |

## Objects

| Object | Description | ID Prefix |
|--------|-------------|-----------|
| **Workspace** | Top-level isolation container | `ws_` |
| **Batch** | A collection of contracts loaded together | `bat_` |
| **Contract** | A single contract derived from file URL/name | Derived key |
| **Document** | A file within a contract | `doc_` |
| **Record** | A single row of data within a sheet | `rec_` |
| **Patch** | A proposed correction with evidence | `pat_` |
| **RFI** | Request for Information — a question about a record or patch | `rfi_` |
| **Evidence Pack** | Bundled proof supporting a patch (PDF anchors, observations, justification) | `evp_` |
| **Signal** | A deterministic flag generated by semantic rules | `sig_` |
| **Triage Item** | A queued item for analyst review | `tri_` |
| **Annotation** | A note attached to a record or field | `ann_` |
| **Audit Event** | An immutable record of a governance action | `aud_` |
| **Drive Connection** | OAuth credentials linking a workspace to Google Drive | `drc_` |
| **Drive Import Provenance** | Tracking record for a file imported from Drive | `drv_` |
| **Selection Capture** | A saved grid selection for batch operations | `sel_` |

## Patch Lifecycle (12 Statuses)

Visible statuses:
1. `DRAFT` — Analyst is working on it
2. `SUBMITTED` — Sent for verification
3. `VERIFIER_REVIEWING` — Verifier has picked it up
4. `RFI_OPEN` — Verifier raised a question
5. `RFI_RESPONDED` — Analyst answered the RFI
6. `VERIFIER_APPROVED` — Verifier says it's correct
7. `VERIFIER_REJECTED` — Verifier says it's wrong
8. `ADMIN_REVIEWING` — Admin is considering promotion
9. `ADMIN_PROMOTED` — Admin approved, promoted to truth
10. `APPLIED` — Changes applied to canonical dataset

Hidden statuses: `SUPERSEDED`, `WITHDRAWN`

## Export Modes

| Mode | What It Includes | Use Case |
|------|-----------------|----------|
| **Export** | Data sheets with edits only — no audit trail sheets | Analyst wants a clean Excel with just the corrected data |
| **Export Full** | Data sheets + change log + RFIs & Analyst Notes + signals summary + metadata + audit log | Full audit package for handoff |
| **Save to Drive** | Same as Export Full, uploaded to Google Drive | Verifier picks up the file from Drive and sees all changes, notes, and audit trail |

All exports use status-based naming: `{dataset}__{STATUS}__{yyyy-mm-dd_HH-mm}__{workspace}.xlsx`

Cell styling on export: Blocker cells = red, RFI cells = orange, Verified cells = green.

## Data Quality Gates

| Gate | Fires When | Blocks If |
|------|-----------|-----------|
| **Pre-Flight: Unknown Columns** | Workbook loaded | Unrecognized column headers found |
| **Pre-Flight: OCR Quality** | PDF scanned | Non-searchable or mojibake content detected |
| **Pre-Flight: Duplicate Accounts** | Workbook loaded | Duplicate account pairs detected |
| **Pre-Flight: Incomplete Addresses** | Workbook loaded | Address fields missing city/state/zip |
| **Schema Validation** | Patch submitted | Required fields missing or invalid format |
| **Evidence Gate** | Patch submitted | No evidence pack attached |
| **Role Gate** | Approval attempted | Wrong role or self-approval attempted |

## Identity Keys

Record identity is defined by four fields: `tenant_id`, `division_id`, `dataset_id`, `record_id`.

Join strategy across pipeline stages: `contract_key` → `file_url` → `file_name` (fallback order). No fabricated identifiers. Unmatched cases surface as issues, never silent joins.

## Semantic Rules

Rules follow a WHEN/THEN pattern defined in the rules bundle:
- `field_meta.json` — 442 field definitions with types, requirements, and validation rules
- `qa_flags.json` — Quality assurance signal definitions
- `hinge_groups.json` — 47 hinge group definitions linking related fields
- `sheet_order.json` — Canonical ordering of contract sections
- `column_aliases.json` — 479 alias entries mapping variant column names to canonical names
- `document_types.json` — Document type classification rules

## API Surface

Base path: `/api/v2.5/`

Authentication: Bearer JWT (Google OAuth) or API key. Dual-accept on reads.

Key endpoints:
- `GET/POST /workspaces` — Workspace CRUD
- `GET/POST /workspaces/{ws}/batches` — Batch management
- `GET/POST/PATCH /workspaces/{ws}/patches` — Patch lifecycle with 22-transition matrix
- `POST /auth/google/verify` — Google OAuth token verification
- `GET /auth/me` — Current user info
- `GET/POST/PATCH/DELETE /workspaces/{ws}/members` — Member management (admin-only)
- `POST /workspaces/{ws}/drive/connect` — Initiate Drive OAuth
- `GET /workspaces/{ws}/drive/browse` — Browse Drive folders
- `POST /workspaces/{ws}/drive/import` — Import file from Drive
- `POST /workspaces/{ws}/drive/export` — Export file to Drive
- `GET /health` — System health check

## Non-Negotiables (v2.5)

1. Resource-based REST routes
2. PATCH method for state transitions
3. ULID primary keys everywhere
4. Optimistic concurrency (409 STALE_VERSION)
5. No self-approval — server-enforced
6. Append-only audit events
7. PostgreSQL as canonical store
8. All Drive actions auditable
9. Secrets in environment variables only
