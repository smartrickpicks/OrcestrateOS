# V2.53 UX Fine-Tuning — Design & Implementation Document

**Date:** 2026-02-14
**Status:** Draft — Pending Go/No-Go
**Scope:** UX-001 through UX-007, EV-001 through EV-004, RV-001, DOC-001, QA-001, SF-001 (future)

---

## 1. Audit Snapshot — Current Behavior by Area

### 1A. Field Grouping (Record Inspector)

**Current:** `orderFieldsForInspector()` groups fields into Primary/Secondary/Other via hinge_groups.json. As of v2.53, when `enrichments.section_metadata` exists for a sheet, fields are grouped by `section_key` with `question_order` sorting. Section headers show title and description.

**Pain points:**
- Group headers are uppercase, small text — difficult to scan in long field lists (especially sheets with 100+ fields like Accounts or Opportunities).
- The "Other Fields" bucket can be large (20-40 fields) with no sub-grouping, making it a wall of cards.
- Section metadata grouping produces 8-11 sections per sheet, but no visual affordance for collapse/expand — all sections render fully open.
- No field count per section visible in the group header.

### 1B. Contract-Line-Item Chip

**Current:** The Record Inspector header area shows contextual role/type chips (e.g., `Catalog`, `Distribution Agreement`). These are derived from `record._document_role` and `record._document_type` at render time and never refresh if the record's classification changes during the session.

**Pain point:** If an analyst confirms a document role suggestion, the chip text remains stale until the inspector is fully re-opened. The chip does not react to `document_role_confirmed` audit events.

### 1C. API Label Noise

**Current:** Field labels are generated by stripping `_c` suffix and converting snake_case to Title Case (`key.replace(/_c$/i, '').replace(/_/g, ' ').replace(/\b\w/g, ...)`). This runs in `renderFieldCard()` at line ~33200.

**Pain points:**
- Salesforce suffixes like `__c` (double underscore) are not stripped — only `_c` is handled.
- Abbreviations like `Pmt`, `Freq`, `Terr`, `Acct` are not expanded — labels read as jargon.
- `field_meta.json` already has a `field_label` for every field (442 fields), but the label is only used in the glossary tooltip — not as the primary display label.

### 1D. Section Guidance Card Readability

**Current:** `renderSectionGuidanceCard()` renders a collapsible card at the top of the field list. As of v2.53, it reads `section_focus` from section_metadata first, falling back to `config/section_guidance.json`.

**Pain points:**
- The card uses inline styles with small font sizes (0.78em, 0.8em) that are difficult to read.
- `section_focus` from metadata is a single long paragraph — it renders as a single bullet in a list, not as readable prose.
- When collapsed, the chevron (▲/▼) is the only visual indicator — no summary text is visible.
- Card lacks a visual distinction between metadata-sourced focus (authoritative) and JSON-config fallback (generic).

### 1E. Linked Fields Wiring

**Current:** Three separate locations show "No linked fields" empty states: Evidence Viewer anchors panel (line ~3176), Record Inspector linked-fields tab (line ~3421), and Evidence Inspector tab (line ~3449). These sections have placeholder UI but no wiring to actual field-to-field relationships.

**Pain point:** The infrastructure exists (empty containers with `.ev-ri-empty` class) but no data source defines which fields link to which. `field_meta.json` does not have a `linked_fields` property. The UI shows "No linked fields" 100% of the time.

### 1F. Context Menu Parity

**Current:** The grid context menu (`_gridCtxOpen()` at line ~20022) offers 7 actions across 4 groups: Navigation (Inspect, Review Mode), Patch Actions (Correction, RFI, Blacklist), Line Item Actions (Add Contract Line Items), Reference (Open in Glossary). The Evidence Viewer has a different selection-based action menu (`_evShowSelMenu()`) that offers: Create Evidence Mark, Create RFI, Create Correction.

**Pain point:** The grid context menu does not include an "Open in Evidence Viewer" action. The Evidence Viewer selection menu does not include Blacklist or Glossary options. There is no unified action set.

### 1G. Bulk Review / Verify

**Current:** Field verification is strictly one-at-a-time. The `srrVerify()` function marks a single field as "verified." There is no "Verify All Remaining" or "Bulk Verify" capability. Filter chips show counts (Todo, Verified, RFI, Patched) but no batch operations.

**Pain point:** For records with 50-120 fields, verifying one-by-one is tedious. Analysts want to verify an entire section at once after reviewing it.

### 1H. Mojibake Highlight Granularity

**Current:** Mojibake detection uses `MOJIBAKE_REGEX` (replacement chars, common encoding artifacts). In the Reader view, entire paragraphs/nodes get classified as `suspect` or `unreadable` via CSS classes `.ev-moji-suspect` and `.ev-moji-unreadable`. The signal engine generates a `MOJIBAKE_DETECTED` signal at the field level.

**Pain point:** A single mojibake character in a 500-word paragraph marks the entire paragraph as suspect. There is no inline highlighting of the specific affected characters — the entire node gets the yellow/red border treatment.

---

## 2. Proposed UX/Behavior Changes

### UX-001: Collapsible Section Groups in Record Inspector

| Aspect | Before | After |
|--------|--------|-------|
| Section headers | Static, always open | Clickable, collapse/expand toggle per section |
| Field count | Not shown | Shown in header: "Core Deal Identity (12 fields)" |
| Default state | All open | All open on first load; remembered via localStorage |
| Other Fields | Flat list | Collapsed by default if > 15 fields |
| Visual | Uppercase text only | Chevron icon + field count + collapse animation |

**Scope:** `renderSrrFields()`, section group header HTML generation.

### UX-002: Live Contract Chip Refresh

| Aspect | Before | After |
|--------|--------|-------|
| Role/type chips | Set once at render | Updated on `document_role_confirmed` audit event |
| Staleness | Persists until drawer re-open | Refreshes in-place within 200ms of confirmation |

**Scope:** `srrRefreshGuidanceAndRail()`, chip elements in inspector header, `AuditTimeline.on()` listener.

### UX-003: Canonical Field Labels from field_meta

| Aspect | Before | After |
|--------|--------|-------|
| Label source | Snake-case → Title Case transform | `field_meta.field_label` when available, fallback to transform |
| Salesforce `__c` | Not stripped | Stripped (both `_c` and `__c`) |
| Abbreviations | Raw (Pmt, Freq, Acct) | Resolved via `field_label` from glossary |

**Scope:** `renderFieldCard()` label generation, `buildGlossaryTooltip()`.

### UX-004: Section Guidance Card Readability

| Aspect | Before | After |
|--------|--------|-------|
| Font size | 0.78em / 0.8em | 0.85em / 0.88em |
| section_focus text | Rendered as single list bullet | Rendered as paragraph block with `line-height: 1.6` |
| Collapsed state | Chevron only | Chevron + first 80 chars of focus text as preview |
| Source indicator | None | Small badge: "From schema" (metadata) or "Default guidance" (JSON fallback) |

**Scope:** `renderSectionGuidanceCard()`, `_getSectionFocusFromMeta()`, CSS.

### UX-005: Linked Fields Placeholder Upgrade

| Aspect | Before | After |
|--------|--------|-------|
| Empty state | Generic "No linked fields" text | Contextual message: "Field linking is available when field relationships are defined in the schema." |
| Future-readiness | No hook | Stub function `_resolveLinkedFields(sheetName, fieldKey)` returns empty array, ready for wiring |

**Scope:** Evidence Viewer anchors panel, Record Inspector linked-fields tab, Evidence Inspector tab.

### UX-006: Context Menu Parity

| Aspect | Before | After |
|--------|--------|-------|
| Grid menu | 7 actions, no EV entry | 8 actions: adds "Open in Evidence Viewer" under Navigation |
| EV selection menu | 3 actions | 4 actions: adds "Open in Glossary" under Reference |
| Keyboard | Shift+F10 for grid only | Shift+F10 also works in EV mode (delegates to appropriate menu) |

**Scope:** `_gridCtxOpen()` sections array, `_evShowSelMenu()`, keyboard handler.

### UX-007: Bulk Verify by Section

| Aspect | Before | After |
|--------|--------|-------|
| Verification | One field at a time | "Verify Section" button in each section group header |
| Scope | Single field | All `todo` fields within the section group |
| Audit | Single field event | Batch event: `fields_bulk_verified` with field list |
| Guard | None | Confirmation modal: "Verify all N remaining fields in [Section Name]?" |

**Scope:** `renderSrrFields()` group header HTML, new `srrBulkVerifySection()` function, `AuditTimeline.emit()`.

### EV-001: Inline Mojibake Character Highlighting

| Aspect | Before | After |
|--------|--------|-------|
| Granularity | Entire paragraph | Individual character/character-run spans |
| Visual | Yellow/red left-border on paragraph | Inline `<mark>` with amber/red background on affected characters |
| Paragraph class | Still applied | Still applied (for overall tint), but individual chars are highlighted |
| Hover | No tooltip | Tooltip on highlighted span: "Possible encoding issue (U+FFFD)" |

**Scope:** Reader text rendering pipeline, `_evRenderReaderContent()`, CSS.

### EV-002: Evidence Viewer Selection Menu — Decline Wording Parity

| Aspect | Before | After |
|--------|--------|-------|
| Selection menu actions | "Create Evidence Mark", "Create RFI", "Create Correction" | No change (no "Reject" wording present) |

**Status:** Already compliant. The Evidence Viewer selection menu does not use "Reject" terminology anywhere. No change required. Verified at `_evShowSelMenu()`.

### EV-003: Evidence Viewer — PDF Page Memory

| Aspect | Before | After |
|--------|--------|-------|
| Page position | Saved per record via `saveSrrPdfState()` | No change needed — already persists page + zoom |

**Status:** Already implemented. `loadSrrPdfState(record)` restores page/zoom from `localStorage`. No change required.

### EV-004: Evidence Viewer Anchor Count in Header

| Aspect | Before | After |
|--------|--------|-------|
| Anchor count | Shown in collapsible section title | Shown additionally in the Evidence Viewer panel header tab |
| Badge | Not present in tab | Small count badge next to "Anchors" tab label |

**Scope:** Evidence Viewer panel tab HTML, `_evRenderAnchorsPanel()`.

### RV-001: Review Mode — Section Guidance Sticky

| Aspect | Before | After |
|--------|--------|-------|
| Guidance card | Scrolls with field list | Sticky at top of field list container (CSS `position: sticky; top: 0; z-index: 5`) |
| Behavior | Scrolls off-screen | Always visible as analyst scrolls through fields |

**Scope:** CSS for `#section-guidance-card`.

### DOC-001: Section Metadata Schema Documentation

| Aspect | Before | After |
|--------|--------|-------|
| Documentation | Described in replit.md | Full schema reference in `docs/handoff/V253_SECTION_METADATA_SCHEMA.md` |
| Content | — | Field-level schema for section_headers, field_section_map, section_focus, qa |

**Scope:** New markdown file. No code changes.

### QA-001: Section Grouping QA Gate

| Aspect | Before | After |
|--------|--------|-------|
| QA coverage | No test for section grouping | QA check verifies: section count, field coverage, question_order continuity, fallback behavior |
| Integration | — | Added to QARunner suite as `section_metadata_integrity` check |

**Scope:** QARunner suite registration, new check function.

### SF-001: Salesforce Field Resolve (FUTURE — SCOPED OUT)

| Aspect | Before | After |
|--------|--------|-------|
| Status | Not implemented | Remains not implemented |
| Scope | — | Future sprint: resolve Salesforce API field names to human-readable labels via org metadata |
| Dependency | — | Requires Salesforce Connected App OAuth or metadata API access |

**Action:** No implementation in this sprint. Documented here as a future item only.

---

## 3. Technical Touchpoints

| Task ID | Primary Files | Modules Impacted |
|---------|--------------|-----------------|
| UX-001 | `ui/viewer/index.html` | `renderSrrFields()`, CSS `.srr-field-group-header` |
| UX-002 | `ui/viewer/index.html` | Inspector header chips, `AuditTimeline.on()` |
| UX-003 | `ui/viewer/index.html` | `renderFieldCard()`, `getFieldMeta()` |
| UX-004 | `ui/viewer/index.html` | `renderSectionGuidanceCard()`, `_getSectionFocusFromMeta()`, CSS |
| UX-005 | `ui/viewer/index.html` | Anchors panel, linked-fields tab, Evidence Inspector tab |
| UX-006 | `ui/viewer/index.html` | `_gridCtxOpen()`, `_evShowSelMenu()`, keyboard handler |
| UX-007 | `ui/viewer/index.html` | `renderSrrFields()`, new `srrBulkVerifySection()` |
| EV-001 | `ui/viewer/index.html` | Reader text renderer, CSS `.ev-moji-*` |
| EV-002 | — | No change required |
| EV-003 | — | No change required |
| EV-004 | `ui/viewer/index.html` | EV panel tabs, `_evRenderAnchorsPanel()` |
| RV-001 | `ui/viewer/index.html` | CSS `#section-guidance-card` |
| DOC-001 | `docs/handoff/V253_SECTION_METADATA_SCHEMA.md` | New doc file only |
| QA-001 | `ui/viewer/index.html` | QARunner suite |
| SF-001 | — | Future sprint, no files |

---

## 4. Risk + Fallback Strategy

| Risk | Severity | Mitigation |
|------|----------|------------|
| UX-001 collapse state not persisting across sessions | Low | Use `localStorage` key `srr_section_collapse_state` with sheet-scoped JSON; fallback to all-open on parse error |
| UX-003 field_label missing for some fields | Low | Already verified all 442 fields have `field_label` in current `field_meta.json`; transform fallback preserved for future/custom fields |
| UX-007 bulk verify accidentally verifying locked/RFI fields | Medium | Guard: only verify fields with state `todo`; skip `rfi`, `blocked`, `locked` states; confirmation modal shows exact count |
| EV-001 inline highlighting breaking text selection | Medium | Use non-interactive `<mark>` elements; ensure `user-select: text` on marks; test selection across highlighted spans |
| EV-001 regex-based mojibake detection producing false positives on intentional Unicode | Low | Keep existing paragraph-level classification as primary signal; inline marks are visual enhancement only, not data-altering |
| UX-006 context menu item count growing too large | Low | Current total: 8 items + 4 headers = 12 entries; well within usability guidelines (< 15) |
| RV-001 sticky guidance card overlapping content | Low | Use `z-index: 5` and `background: white` with shadow to prevent content bleed-through; test with long guidance text |

**Global fallback:** All changes are additive with feature-flag potential. If any UX change causes regression, the prior behavior is preserved via conditional guards (e.g., `if (sectionMeta)` already gates the section grouping path).

---

## 5. Acceptance Criteria per Task ID

### UX-001: Collapsible Section Groups
- [ ] Each section header is clickable and toggles collapse/expand of its fields
- [ ] Field count shows in header: "Section Name (N fields)"
- [ ] Collapse state persists across field list re-renders within the same session
- [ ] "Other Fields" section collapses by default when > 15 fields
- [ ] Sheets without section_metadata use legacy grouping unchanged

### UX-002: Live Contract Chip Refresh
- [ ] After `document_role_confirmed` event, inspector header chip updates within 200ms
- [ ] Chip text matches the new `_document_role` value
- [ ] No chip update occurs if the inspector is not open

### UX-003: Canonical Field Labels
- [ ] Field cards display `field_label` from `field_meta.json` when available
- [ ] Fields not in `field_meta.json` fall back to existing snake_case → Title Case transform
- [ ] Both `_c` and `__c` suffixes are stripped in the fallback path
- [ ] Glossary tooltip still shows the raw `field_key` for reference

### UX-004: Section Guidance Card Readability
- [ ] Font sizes increased to 0.85em / 0.88em
- [ ] `section_focus` text renders as paragraph, not bullet list
- [ ] Collapsed state shows first 80 chars of focus text as preview
- [ ] Source badge distinguishes metadata-sourced vs JSON-fallback guidance
- [ ] Existing collapse/expand toggle still works

### UX-005: Linked Fields Placeholder
- [ ] All three empty states show contextual message instead of generic "No linked fields"
- [ ] `_resolveLinkedFields()` stub exists and returns empty array
- [ ] No console errors when linked-fields sections are rendered

### UX-006: Context Menu Parity
- [ ] Grid context menu includes "Open in Evidence Viewer" under Navigation
- [ ] EV selection menu includes "Open in Glossary" under Reference
- [ ] Action state respects role permissions (same guards as existing actions)
- [ ] Keyboard shortcut Shift+F10 works in both grid and EV modes

### UX-007: Bulk Verify by Section
- [ ] "Verify Section" button appears in each section group header (section metadata path only)
- [ ] Button only counts and verifies fields with state `todo`
- [ ] Confirmation modal shows exact count: "Verify N remaining fields in [Section Name]?"
- [ ] `fields_bulk_verified` audit event emits with field list and section name
- [ ] Locked, RFI, and blocked fields are excluded from bulk verify
- [ ] Filter chip counts update after bulk verify

### EV-001: Inline Mojibake Highlighting
- [ ] Individual mojibake characters wrapped in `<mark class="ev-moji-inline">` spans
- [ ] Paragraph-level suspect/unreadable classification still applies
- [ ] Hover tooltip on inline marks shows character code point
- [ ] Text selection works across inline marks without fragmentation
- [ ] Non-mojibake Unicode characters (e.g., accented Latin, CJK) are not marked

### EV-002: (No change required)
- [x] Verified: No "Reject" wording in Evidence Viewer selection menu

### EV-003: (No change required)
- [x] Verified: PDF page/zoom state persists via `loadSrrPdfState()` / `saveSrrPdfState()`

### EV-004: Anchor Count Badge in Header Tab
- [ ] Anchors tab label shows count badge: "Anchors (N)"
- [ ] Badge updates when anchors are added/removed
- [ ] Badge is zero-suppressed (no badge shown when count is 0)

### RV-001: Sticky Guidance Card
- [ ] Guidance card stays visible when scrolling the field list
- [ ] Card has white background with subtle shadow to prevent content bleed
- [ ] Sticky behavior does not break collapse/expand toggle
- [ ] Sticky only applies within the field list container, not the full page

### DOC-001: Section Metadata Schema Documentation
- [ ] `docs/handoff/V253_SECTION_METADATA_SCHEMA.md` exists
- [ ] Documents: section_headers structure, field_section_map structure, section_focus format, qa fields
- [ ] Includes example JSON for one complete sheet
- [ ] Cross-references `orderFieldsForInspector()` and `_getSectionFocusFromMeta()`

### QA-001: Section Grouping QA Gate
- [ ] QARunner includes `section_metadata_integrity` check
- [ ] Check validates: each sheet in section_metadata has section_headers and field_section_map
- [ ] Check validates: all field_section_map entries reference valid section_keys from section_headers
- [ ] Check validates: question_order values are unique within each section
- [ ] Check reports pass/fail per sheet

### SF-001: (Future — No implementation)
- [x] Scoped out. No acceptance criteria for this sprint.

---

## 6. Follow-Up Clarity Questions (Required Decisions Only)

### Q1: UX-001 — Collapse Default State
Should all sections start **open** on first load, or should sections with zero signals/issues start **collapsed**?
- **Option A:** All open (simple, no signal dependency)
- **Option B:** Signal-aware collapse (sections with 0 signals collapsed, >0 open)
- **Recommendation:** Option A. Signal-aware collapse adds complexity and may hide fields that need review.

### Q2: UX-003 — Label Source Priority
Should `field_label` from `field_meta.json` always win, or should the analyst be able to toggle between "canonical label" and "API field name" views?
- **Option A:** `field_label` always, raw key in tooltip (simpler)
- **Option B:** Toggle switch in field list header (more flexible)
- **Recommendation:** Option A. Toggle adds UI surface with marginal benefit. The glossary tooltip already shows the raw key.

### Q3: UX-007 — Bulk Verify Scope
Should bulk verify apply only to fields visible after filtering (e.g., only "To Do" tab fields), or all `todo` fields in the section regardless of active filter?
- **Option A:** All `todo` fields in section, regardless of filter
- **Option B:** Only currently visible `todo` fields in section
- **Recommendation:** Option A. Filtering is a display concern; verification is a data concern. Verifying should be exhaustive within the section.

### Q4: EV-001 — Mojibake False Positive Tolerance
The current regex matches common encoding artifacts but may flag legitimate accented characters in non-English text. Should we add a Unicode script whitelist (Latin Extended, CJK ranges) to exclude from detection?
- **Option A:** Keep current regex, accept some false positives (simpler)
- **Option B:** Add whitelist for known-good Unicode ranges (more accurate, more complexity)
- **Recommendation:** Option A for this sprint; if false positive reports surface, add whitelist as a follow-up.

### Q5: EV-004 — Anchor Count Source
Should the anchor count in the header tab reflect all anchors for the record, or only anchors for the currently visible page?
- **Option A:** All anchors for the record (consistent with panel content)
- **Option B:** Page-scoped count (more contextual)
- **Recommendation:** Option A. The panel already shows all anchors regardless of page.

---

## 7. Go/No-Go for Implementation Start

### Prerequisites Met
- [x] Section metadata integration (v2.53) — complete and tested
- [x] Section focus guidance (v2.53) — complete and tested
- [x] Module registry (D16) — complete and tested
- [x] Glossary definitions — complete with fallback
- [x] Smoke tests passing
- [x] Server running with all 9 migrations applied

### Implementation Readiness

| Task ID | Ready | Blockers |
|---------|-------|----------|
| UX-001 | Yes | Needs Q1 decision (default: Option A) |
| UX-002 | Yes | None |
| UX-003 | Yes | Needs Q2 decision (default: Option A) |
| UX-004 | Yes | None |
| UX-005 | Yes | None |
| UX-006 | Yes | None |
| UX-007 | Yes | Needs Q3 decision (default: Option A) |
| EV-001 | Yes | Needs Q4 decision (default: Option A) |
| EV-002 | N/A | Already compliant |
| EV-003 | N/A | Already implemented |
| EV-004 | Yes | Needs Q5 decision (default: Option A) |
| RV-001 | Yes | None |
| DOC-001 | Yes | None |
| QA-001 | Yes | None |
| SF-001 | N/A | Future sprint |

### Recommendation

**Go.** All 10 actionable tasks (excluding EV-002, EV-003, SF-001) have clear scope, identified touchpoints, and no hard blockers. Five tasks have optional decision points with sensible defaults. Estimated effort: 2-3 implementation sessions.

### Suggested Implementation Order

1. **RV-001** (CSS-only, < 5 min) — quick win
2. **UX-005** (text change, < 10 min) — quick win
3. **UX-004** (guidance card readability) — builds on existing v2.53 work
4. **UX-003** (canonical labels) — data source already available
5. **UX-002** (live chip refresh) — event listener wiring
6. **UX-001** (collapsible sections) — largest UI change, builds on UX-003
7. **EV-004** (anchor count badge) — small scope
8. **UX-006** (context menu parity) — moderate scope
9. **UX-007** (bulk verify) — needs most testing
10. **EV-001** (mojibake inline) — most complex, highest regression risk
11. **DOC-001** (documentation) — anytime
12. **QA-001** (QA gate) — after UX-001 is stable
